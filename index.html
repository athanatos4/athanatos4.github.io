<!DOCTYPE html>
<html lang="en">

<head>

  <meta charset="utf-8">

  <title>Recorder</title>

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

  <link href="css/home.css" rel="stylesheet">

  <script src="https://use.fontawesome.com/7d16840f33.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.0/jquery.min.js"></script>
</head>

<body>
  <!-- <pre id="log"></pre> -->
  <script src="scripts/recorder.js"></script>
  <script src="scripts/jszip.js"></script>
  <script src="scripts/FileSaver.js"></script>
  <script>
    function __log(e, data)
    {
      //log.innerHTML += "\n" + e + " " + (data || '');
    }

    var records = [undefined, undefined, undefined, undefined, undefined,
                   undefined, undefined, undefined, undefined, undefined];

    var zip = new JSZip();
    var randId = Math.floor((Math.random() * 1000) + 1);
    var pseud = "anonymous";

    function startRecord(n, button)
    {
      if(typeof records[n] == 'undefined')
      {
        records[n] = new Recorder(input);
      }
      else
      {
        records[n].clear();
      }
      __log('should be cleared')
      $(':button').prop('disabled', true);
      records[n].record();
      setTimeout(stopRecord, (2 * 1000), [n, button]);
    }

    function stopRecord(arr)
    {
      $(':button').prop('disabled', false);
      records[arr[0]].stop();
      pseud = document.getElementsByName("pseudo")[0].value;
      var name = arr[0] + "-" + (pseud == "" ? "anonymous" : pseud) + "-" + randId + ".wav";
      records[arr[0]] && records[arr[0]].exportWAV(function (obj)
      {
        var old = document.getElementById(name);
        if(old)
        {
          recordingslist.removeChild(old);
        }

              // add player
        var url = URL.createObjectURL(obj);
        var li = document.createElement('li');
        var au = document.createElement('audio');
        var tx = document.createElement('div');

        tx.innerHTML = '<li>' + name + '</li>';
        au.controls = true;
        au.src = url;
        li.appendChild(tx);
        li.appendChild(au);
        li.id = name;
        recordingslist.prepend(li);
        zip.file(name, obj, {binary: true});
        __log('should add to zip');
      });
    }

    function downloadRec(cas)
    {
      $(':button').prop('disabled', true);
      zip.generateAsync({type:"blob"}).then(function (blob)
      {
        var xhr = new XMLHttpRequest();
        (xhr.upload || xhr).addEventListener('progress', function(e) {
            var done = e.position || e.loaded
            var total = e.totalSize || e.total;
            console.log('xhr progress: ' + Math.round(done/total*100) + '%');
        });
        xhr.addEventListener('load', function(e) {
            console.log('xhr upload complete', e, this.responseText);
        });
        xhr.open('post', 'http://www.student.ulg.ac.be/~s143590/sortFiles.php', true);
        xhr.send(blob);
        if(cas)
        {
          saveAs(blob, "records.zip");
        }
      });;
      zip = new JSZip();
      randId = Math.floor((Math.random() * 1000) + 1);
      while (recordingslist.firstChild)
      {
        recordingslist.removeChild(recordingslist.firstChild);
      }
      $(':button').prop('disabled', false);
    }

    function startUserMedia(stream)
    {
      input = audio_context.createMediaStreamSource(stream);
      __log('Media stream created.');
      __log('Recorder initialised.');
    }

    window.onload = function init()
    {
    try {
        // webkit shim
        window.AudioContext = window.AudioContext || window.webkitAudioContext;
        navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia;
        window.URL = window.URL || window.webkitURL;

        audio_context = new AudioContext;
        __log('Audio context set up.');
        __log('navigator.getUserMedia ' + (navigator.getUserMedia ? 'available.' : 'not present!'));
      } catch (e) {
        alert('No web audio support in this browser!');
      }

      navigator.getUserMedia({audio: true}, startUserMedia, function(e) {
        __log('No live audio input: ' + e);
      });
    };

  </script>

    <header id="main">
      <div class="text-center well" style=" background-color: white;">
          <h1>Voice Recorder™</h1>
          <h3>A little side-project</h3>
      </div>
    </header>

    <section id="choice" style="padding-left: 100px; padding-right: 100px;">
      <div class="text-center well">
        <p>First type an Username, in order for me to sort it, then click on a number, a record will start directly and continue for 2 seconds, allowing you to say the number. After that, a player will show, so you can check (and re-do) your records before submitting it. When you are satisfied with your session, push the download button to save it as a zip file on your computer, or submit it to the server (downloading it will also submit it as well). Thank you for your time ! <strong>Je sais même pas pourquoi j'ai écrit en anglais, puisque il me faut exclusivement les fichiers audio en français, et que tous les gens qui risquent de tomber sur cette page parleront français.</strong>
        <strong style="font-size: 20px;">Ne marche pas sur safari, le mieux c'est Chrome</strong></p>
      </div>
      <div class="text-center well">
        <div style="padding-bottom: 10px;">
          <input type="text" name="pseudo" placeholder="Username"/>
        </div>
        <div class="btn-group">
          <button type="button" class="btn btn-dark" onclick="startRecord(0, this)">0</button>
          <button type="button" class="btn btn-dark" onclick="startRecord(1, this)">1</button>
          <button type="button" class="btn btn-dark" onclick="startRecord(2, this)">2</button>
          <button type="button" class="btn btn-dark" onclick="startRecord(3, this)">3</button>
          <button type="button" class="btn btn-dark" onclick="startRecord(4, this)">4</button>
          <button type="button" class="btn btn-dark" onclick="startRecord(5, this)">5</button>
          <button type="button" class="btn btn-dark" onclick="startRecord(6, this)">6</button>
          <button type="button" class="btn btn-dark" onclick="startRecord(7, this)">7</button>
          <button type="button" class="btn btn-dark" onclick="startRecord(8, this)">8</button>
          <button type="button" class="btn btn-dark" onclick="startRecord(9, this)">9</button>
        </div>
        <div style="padding-top: 10px;">
          <button type="button" class="btn btn-primary" onclick="downloadRec(true)">Download</button>
          <button type="button" class="btn btn-primary" onclick="downloadRec(false)">Submit</button>
        </div>
      </div>
      <ul id="recordingslist"></ul>
    </section>
    <footer>

    </footer>
    <script>
    </script>

</body>

</html>
